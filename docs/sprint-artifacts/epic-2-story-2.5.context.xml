<?xml version="1.0" encoding="UTF-8"?>
<story-context id="epic-2-story-2.5" v="1.0">
  <metadata>
    <epicId>Epic 2</epicId>
    <storyId>2.5</storyId>
    <title>Integrate Whitelist Authentication into Webhook</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-2-story-2.5.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system operator</asA>
    <iWant>whitelist validation enforced before any email processing</iWant>
    <soThat>unauthorized senders are blocked immediately with no resource consumption</soThat>
    <tasks>Create src/plugins/auth.ts as Fastify plugin | Implement preHandler hook for whitelist validation | Extract sender email from payload | Call isWhitelisted function | Return HTTP 403 for unauthorized | Return HTTP 200 for authorized | Log blocked attempts | Register auth plugin on webhook route | Write integration tests for auth flow</tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Whitelist validation runs BEFORE any other processing via preHandler hook</criterion>
    <criterion id="2">Sender email extracted from webhook payload</criterion>
    <criterion id="3">Whitelisted sender: request proceeds to route handler, HTTP 200 returned after processing</criterion>
    <criterion id="4">Non-whitelisted sender: HTTP 403 Forbidden returned immediately</criterion>
    <criterion id="5">Response body for 403: { success: false, error: Unauthorized sender }</criterion>
    <criterion id="6">No internal system details exposed in 403 response</criterion>
    <criterion id="7">Blocked attempt logged with sender info at warn level</criterion>
    <criterion id="8">Validation runs before content extraction or logging of email content</criterion>
    <criterion id="9">HTTP status codes: 200 success, 403 forbidden, 500 internal error</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Security & Access Control</section>
        <snippet>FR7-9: Validate sender against whitelist, block non-whitelisted with HTTP 403</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Security Architecture</section>
        <snippet>Whitelist-Based Access Control runs in Fastify preHandler hook BEFORE route handler. No session/token management for MVP.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.5</section>
        <snippet>Create plugins/auth.ts as Fastify plugin. Register as preHandler hook on webhook route. Security: never reveal which emails are whitelisted in error messages.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/routes/webhook.ts</path>
        <kind>route</kind>
        <symbol>webhookRoute</symbol>
        <reason>Webhook route where auth plugin is registered</reason>
      </artifact>
      <artifact>
        <path>src/services/whitelist.ts</path>
        <kind>service</kind>
        <symbol>isWhitelisted</symbol>
        <reason>Core whitelist validation function called by auth plugin</reason>
      </artifact>
      <artifact>
        <path>src/lib/schemas.ts</path>
        <kind>schema</kind>
        <symbol>WebhookPayloadSchema</symbol>
        <reason>Zod schema defining payload structure with from field</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="fastify" version="latest"/>
        <package name="zod" version="latest"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Auth validation must run in preHandler hook BEFORE route handler</constraint>
    <constraint>Hook runs BEFORE payload is fully processed or logged</constraint>
    <constraint>Error response must not reveal internal details or system information</constraint>
    <constraint>Must prevent resource consumption for blocked requests</constraint>
    <constraint>Response must be HTTP 403 for blocked, 200 for success, 500 for errors</constraint>
    <constraint>Plugin must be registered specifically on webhook route, not globally</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>authPlugin</name>
      <kind>Fastify plugin</kind>
      <signature>export default async function authPlugin(fastify: FastifyInstance) { fastify.addHook('preHandler', ...); }</signature>
      <path>src/plugins/auth.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Integration tests verifying auth enforcement on webhook route. Test whitelisted vs non-whitelisted senders. Verify 403 response, verify hook runs before route handler, verify logging.</standards>
    <locations>src/routes/webhook.test.ts</locations>
    <ideas>
      <idea id="1">Whitelisted sender receives HTTP 200 after processing</idea>
      <idea id="2">Non-whitelisted sender receives HTTP 403 immediately</idea>
      <idea id="3">403 response contains no internal system details</idea>
      <idea id="4">Blocked attempt logged at warn level with sender email</idea>
      <idea id="5">Hook prevents route handler from executing for blocked sender</idea>
      <idea id="6">Hook runs before any content processing or logging</idea>
      <idea id="7">Multiple non-whitelisted requests all blocked consistently</idea>
      <idea id="8">Domain-based whitelist works correctly in hook</idea>
    </ideas>
  </tests>
</story-context>
