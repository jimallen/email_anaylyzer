<?xml version="1.0" encoding="UTF-8"?>
<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5.5</storyId>
    <title>Orchestrate End-to-End Request Flow in Webhook Handler</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-5-story-5.5.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>team member</asA>
    <iWant>the complete email analysis workflow to execute seamlessly</iWant>
    <soThat>I send a draft email and receive feedback without any manual steps</soThat>
    <tasks>
      <task>Update src/routes/webhook.ts POST handler for complete orchestration</task>
      <task>Implement content extraction phase with error handling</task>
      <task>Implement LLM analysis phase with timeout protection</task>
      <task>Implement response delivery phase with retry logic</task>
      <task>Implement error handling for ContentProcessingError</task>
      <task>Implement error handling for LLMError</task>
      <task>Implement error handling for unexpected errors</task>
      <task>Add request timing tracking and logging</task>
      <task>Implement correlation ID tracking through all logs</task>
      <task>Add warning log if 30-second target exceeded</task>
      <task>Write integration tests for complete workflow</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Content extraction executes first, extracts text and images from payload</criterion>
    <criterion id="AC2">LLM analysis executes after extraction, formats request and analyzes content</criterion>
    <criterion id="AC3">Success response formats email and sends with retry logic</criterion>
    <criterion id="AC4">ContentProcessingError caught, error email formatted and sent with retry</criterion>
    <criterion id="AC5">LLMError caught, error email formatted and sent with retry</criterion>
    <criterion id="AC6">Unexpected errors log stack trace and return HTTP 500</criterion>
    <criterion id="AC7">Known errors return HTTP 200 to Resend (processed)</criterion>
    <criterion id="AC8">Total processing time tracked and logged in milliseconds</criterion>
    <criterion id="AC9">Warning logged if processing exceeds 30-second target</criterion>
    <criterion id="AC10">Correlation ID ties all logs together from start to finish</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>User Workflow and Integration Points</section>
        <snippet>Team member drafts email → takes screenshot → attaches screenshot to email → sends to analyzer service → receives feedback within 30 seconds</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Response Generation (FR21-25) and Error Handling (FR26-32)</section>
        <snippet>FR24: System sends responses within 30 seconds. FR27: System sends fallback error email if LLM fails. FR35-36: Log response delivery and errors with context.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Webhook Handler Flow and Error Strategy</section>
        <snippet>Main orchestration point combining all Epic implementations. Known error types get error emails. Unexpected errors return 500. Always track timing.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 5: Response Delivery & User Feedback and Overall Project Flow</section>
        <snippet>Closes the feedback loop - users get results. Without this, the service has no output. End-to-end orchestration of all previous epics.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/routes/webhook.ts</path>
        <kind>route</kind>
        <symbol>POST /webhook/inbound-email</symbol>
        <reason>Main webhook handler that orchestrates the complete flow</reason>
      </artifact>
      <artifact>
        <path>src/services/email-processor.ts</path>
        <kind>service</kind>
        <symbol>extractAndProcessContent</symbol>
        <reason>Content extraction from Epic 3</reason>
      </artifact>
      <artifact>
        <path>src/services/llm-client.ts</path>
        <kind>service</kind>
        <symbol>analyzeLLM</symbol>
        <reason>LLM analysis from Epic 4</reason>
      </artifact>
      <artifact>
        <path>src/services/email-formatter.ts</path>
        <kind>service</kind>
        <symbol>formatSuccessEmail, formatErrorEmail</symbol>
        <reason>Email formatting from Epic 5 stories 5.2-5.3</reason>
      </artifact>
      <artifact>
        <path>src/services/resend-client.ts</path>
        <kind>service</kind>
        <symbol>sendEmailWithRetry</symbol>
        <reason>Email sending with retry from Epic 5 story 5.4</reason>
      </artifact>
      <artifact>
        <path>src/__tests__/webhook.integration.test.ts</path>
        <kind>test</kind>
        <symbol>Integration test suite</symbol>
        <reason>End-to-end workflow tests with mocked dependencies</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="pino" version="latest">Structured logging with correlation IDs for request tracing</package>
        <package name="fastify" version="latest">Web framework with built-in request context and logging</package>
      </ecosystem>
      <ecosystem name="testing">
        <package name="vitest" version="latest">Testing framework with mocking capabilities</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must execute steps in strict order: extraction → LLM analysis → response delivery</constraint>
    <constraint>ContentProcessingError and LLMError must be caught and handled with error emails</constraint>
    <constraint>Unexpected errors return HTTP 500, known errors return 200</constraint>
    <constraint>All errors that can send emails MUST attempt to send error email to user</constraint>
    <constraint>Total processing time must be tracked and logged</constraint>
    <constraint>Correlation ID must be maintained through entire request lifecycle</constraint>
    <constraint>30-second target is a warning threshold, not a hard limit</constraint>
    <constraint>Processing must be resilient - no step can fully block others except in logical order</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /webhook/inbound-email</name>
      <kind>HTTP endpoint</kind>
      <signature>POST /webhook/inbound-email - accepts Resend webhook payload, returns { success: boolean }</signature>
      <path>src/routes/webhook.ts</path>
    </interface>
    <interface>
      <name>extractAndProcessContent</name>
      <kind>function signature</kind>
      <signature>async function extractAndProcessContent(payload: ResendPayload, logger): Promise&lt;ProcessedContent&gt;</signature>
      <path>src/services/email-processor.ts</path>
    </interface>
    <interface>
      <name>analyzeLLM</name>
      <kind>function signature</kind>
      <signature>async function analyzeLLM(content: ProcessedContent, logger): Promise&lt;string&gt;</signature>
      <path>src/services/llm-client.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use vitest with full mocking of external services (Resend, LLM API, email operations). Integration tests should verify complete happy path (success case) and all error scenarios (content error, LLM error, unexpected error). Tests should mock timing to verify 30-second logging. Verify correlation ID propagation through logs.</standards>
    <locations>src/__tests__/webhook.integration.test.ts</locations>
    <ideas>
      <idea ac="AC1-AC3">Test successful end-to-end flow: payload → extraction → LLM → success email → HTTP 200</idea>
      <idea ac="AC4">Test ContentProcessingError caught and error email sent</idea>
      <idea ac="AC5">Test LLMError caught and error email sent</idea>
      <idea ac="AC6">Test unexpected error returns HTTP 500 with stack trace logged</idea>
      <idea ac="AC7">Test HTTP 200 returned for all known error types</idea>
      <idea ac="AC8">Test total duration logged in request completion log</idea>
      <idea ac="AC9">Test warning logged if processing time exceeds 30 seconds</idea>
      <idea ac="AC10">Test correlation ID (request.id) appears in all related logs</idea>
      <idea>Test each stage timing: extraction &lt;2s, images &lt;10s, LLM &lt;25s, send &lt;2s</idea>
    </ideas>
  </tests>
</story-context>
