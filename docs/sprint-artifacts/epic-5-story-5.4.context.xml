<?xml version="1.0" encoding="UTF-8"?>
<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5.4</storyId>
    <title>Implement Retry Logic for Failed Email Sends</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-5-story-5.4.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system operator</asA>
    <iWant>automatic retry for failed email sends</iWant>
    <soThat>temporary Resend API issues don't prevent users from receiving feedback</soThat>
    <tasks>
      <task>Add sendEmailWithRetry function to src/services/resend-client.ts</task>
      <task>Implement retry logic with 1-second exponential backoff</task>
      <task>Implement isRetryable error detection</task>
      <task>Track retry attempts and total duration</task>
      <task>Log initial failure attempt with details</task>
      <task>Log successful retry with timing</task>
      <task>Log permanent failure after 2 total attempts</task>
      <task>Ensure non-retryable errors throw immediately</task>
      <task>Write unit tests for retry scenarios</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">On first send failure, log warning with attempt number and error details</criterion>
    <criterion id="AC2">Wait exactly 1 second before retry attempt</criterion>
    <criterion id="AC3">Exactly ONE retry is attempted (2 total attempts maximum)</criterion>
    <criterion id="AC4">Successful retry logged with attempt number and total duration</criterion>
    <criterion id="AC5">Permanent failure logged with both attempt counts and last error</criterion>
    <criterion id="AC6">Retryable errors include: network timeouts, HTTP 5xx, connection errors</criterion>
    <criterion id="AC7">Non-retryable errors: HTTP 4xx, invalid emails, missing config (thrown, not retried)</criterion>
    <criterion id="AC8">Total retry duration does not exceed 5 seconds</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Response Generation (FR21-25)</section>
        <snippet>FR25: System retries failed email sends once before logging permanent failure. FR24: System sends responses within 30 seconds.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Services Layer - resend-client.ts</section>
        <snippet>Resend API client for sending emails. Built with native fetch. Handles error conditions gracefully.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 5: Response Delivery & User Feedback</section>
        <snippet>Retry logic for failed sends. Error handling and recovery. Graceful degradation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/resend-client.ts</path>
        <kind>service</kind>
        <symbol>sendEmailWithRetry</symbol>
        <reason>Add retry wrapper around existing sendEmail function</reason>
      </artifact>
      <artifact>
        <path>src/services/resend-client.ts</path>
        <kind>service</kind>
        <symbol>isRetryable</symbol>
        <reason>Helper function to determine if error should be retried</reason>
      </artifact>
      <artifact>
        <path>src/__tests__/resend-client.test.ts</path>
        <kind>test</kind>
        <symbol>Retry logic tests</symbol>
        <reason>Unit tests for retry scenarios, timing, and error handling</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="pino" version="latest">Structured logging for retry attempts and outcomes</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Exactly 1 retry, 2 total attempts maximum</constraint>
    <constraint>1 second wait between attempts</constraint>
    <constraint>Total duration must not exceed 5 seconds</constraint>
    <constraint>Non-retryable errors must throw (not retry)</constraint>
    <constraint>Logging must track attempt count and durations</constraint>
    <constraint>Function returns EmailResult with success flag, not exceptions for retryable failures</constraint>
    <constraint>Network timeouts and 5xx errors are retryable</constraint>
    <constraint>4xx errors and validation errors are not retryable</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>sendEmailWithRetry</name>
      <kind>function signature</kind>
      <signature>async function sendEmailWithRetry(to: string, subject: string, body: string): Promise&lt;EmailResult&gt;</signature>
      <path>src/services/resend-client.ts</path>
    </interface>
    <interface>
      <name>isRetryable</name>
      <kind>function signature</kind>
      <signature>function isRetryable(error: any): boolean</signature>
      <path>src/services/resend-client.ts</path>
    </interface>
    <interface>
      <name>EmailResult</name>
      <kind>TypeScript interface</kind>
      <signature>interface EmailResult { success: boolean; error?: Error; duration?: number; attempts?: number; }</signature>
      <path>src/lib/types.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use vitest with mock fetch API. Tests should simulate Resend API failures (timeouts, 5xx, 4xx). Verify retry logic timing (1 second delay), attempt counting, and logging output. Test that non-retryable errors throw immediately and retryable errors are retried exactly once.</standards>
    <locations>src/__tests__/resend-client.test.ts</locations>
    <ideas>
      <idea ac="AC1">Test warning log on first send failure with error details</idea>
      <idea ac="AC2">Test 1 second delay before retry (use fake timers)</idea>
      <idea ac="AC3">Test exactly one retry (2 total attempts, no more)</idea>
      <idea ac="AC4">Test successful retry logs with correct attempt number and duration</idea>
      <idea ac="AC5">Test permanent failure logs both attempts and final error</idea>
      <idea ac="AC6">Test retryable errors: network timeout, HTTP 500, 503, 504</idea>
      <idea ac="AC7">Test non-retryable errors: 400, 401, 403, 404 throw immediately</idea>
      <idea ac="AC8">Test total duration including wait time stays under 5 seconds</idea>
    </ideas>
  </tests>
</story-context>
