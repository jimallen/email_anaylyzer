<?xml version="1.0" encoding="UTF-8"?>
<story-context id="epic-2-story-2.2" v="1.0">
  <metadata>
    <epicId>Epic 2</epicId>
    <storyId>2.2</storyId>
    <title>Extract Plain Text Content from Email Body</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-2-story-2.2.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>team member</asA>
    <iWant>the service to extract text content from my email body</iWant>
    <soThat>the analyzer can review my written content for tone and brand issues</soThat>
    <tasks>Create src/services/email-processor.ts | Export extractTextContent function | Implement extraction priority | HTML tag stripping | Add logging for metadata | Integrate with webhook handler | Store extracted text in context | Write unit tests</tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Text field extracted and stored for processing</criterion>
    <criterion id="2">HTML field checked when text field missing or empty</criterion>
    <criterion id="3">HTML tags stripped using regex pattern</criterion>
    <criterion id="4">Both missing results in empty string</criterion>
    <criterion id="5">Content metadata logged (hasText, textLength)</criterion>
    <criterion id="6">Extraction logic encapsulated in service module</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Email Reception & Processing</section>
        <snippet>FR3: System extracts plain text content from email body (if present)</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Project Structure</section>
        <snippet>src/services/email-processor.ts module for email processing logic</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.2</section>
        <snippet>Text extraction priority: text field first, then HTML conversion with regex stripping, then empty string</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/routes/webhook.ts</path>
        <kind>route</kind>
        <symbol>webhookRoute</symbol>
        <reason>Webhook endpoint that calls extractTextContent function</reason>
      </artifact>
      <artifact>
        <path>src/lib/schemas.ts</path>
        <kind>schema</kind>
        <symbol>WebhookPayloadSchema</symbol>
        <reason>Zod validation schema defining text and html payload fields</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="fastify" version="latest"/>
        <package name="zod" version="latest"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use simple regex for HTML stripping in MVP</constraint>
    <constraint>Never log actual email content, only metadata</constraint>
    <constraint>Preserve text formatting and line breaks</constraint>
    <constraint>Defer error handling for empty content to Epic 3</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>extractTextContent</name>
      <kind>function</kind>
      <signature>function extractTextContent(payload: WebhookPayload): string</signature>
      <path>src/services/email-processor.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Unit tests with vitest for all extraction scenarios: text-only, html-only, both present, both missing. Verify logging of metadata.</standards>
    <locations>src/services/email-processor.test.ts</locations>
    <ideas>
      <idea id="1">Text field present returns text unchanged</idea>
      <idea id="2">HTML field present without text returns stripped content</idea>
      <idea id="3">Both present returns text (priority)</idea>
      <idea id="4">Both missing returns empty string</idea>
      <idea id="5">Logging contains correct hasText and textLength values</idea>
      <idea id="6">Edge cases: nested tags, entities, whitespace preservation</idea>
    </ideas>
  </tests>
</story-context>
