<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.1</storyId>
    <title>Detect and Parse Image Attachments</title>
    <status>drafted</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/jima/Code/email_anaylyzer/docs/sprint-artifacts/epic-3-story-3.1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>team member</asA>
    <iWant>the service to detect when I include screenshots in my email</iWant>
    <soThat>the analyzer can review both my text and visual presentation</soThat>
    <tasks>
- Extend src/services/email-processor.ts with detectAttachments function
- Define Attachment interface with url, filename, contentType fields
- Handle edge cases: missing attachments field, empty array, attachments without required fields
- Log attachment detection with count and metadata (not URLs)
- Return empty array for missing/empty attachments
- Skip and log warning for attachments without required fields
    </tasks>
  </story>

  <acceptanceCriteria>
**Given** a webhook payload is received
**When** the payload contains an `attachments` array
**Then** the service iterates through all attachments

**And** for each attachment, extracts:
- `url` (download URL from Resend)
- `filename` (original filename)
- `contentType` (MIME type)

**And** attachment detection is logged:
```json
{
  "msg": "Attachments detected",
  "attachmentCount": 2,
  "attachments": [
    {"filename": "screenshot.png", "contentType": "image/png"},
    {"filename": "draft.jpg", "contentType": "image/jpeg"}
  ]
}
```

**And** if no attachments exist (empty array or undefined), service continues with text-only processing

**And** attachment information is stored for download processing in next story
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Email Reception & Processing</section>
        <snippet>FR4: System detects image attachments (screenshots) in incoming email. FR5: System downloads image attachments from Resend's attachment URLs. FR6: System supports common image formats (PNG, JPG, JPEG) for screenshot analysis.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Content Analysis</section>
        <snippet>FR18: System handles screenshot-only emails (no text in body) by sending image-only analysis request. FR19: System handles text-only emails (no screenshot) by sending text-only analysis request. FR20: System handles hybrid emails (text + screenshot) by sending combined multimodal request.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>API Contracts</section>
        <snippet>Webhook payload includes optional attachments array with url, filename, and contentType fields for each attachment.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 3: Content Extraction & Processing</section>
        <snippet>Story 3.1: Detect and Parse Image Attachments - detects image attachments in email and extracts metadata (url, filename, contentType) for download processing in next story.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/routes/webhook.ts</path>
        <kind>route</kind>
        <symbol>webhookRoute</symbol>
        <lines>TBD</lines>
        <reason>Webhook endpoint that receives payload - will call detectAttachments function</reason>
      </artifact>
      <artifact>
        <path>src/services/email-processor.ts</path>
        <kind>service</kind>
        <symbol>extractTextContent</symbol>
        <lines>TBD</lines>
        <reason>Existing text extraction service - attachment detection will be added to same module</reason>
      </artifact>
      <artifact>
        <path>src/lib/schemas.ts</path>
        <kind>schema</kind>
        <symbol>WebhookPayloadSchema</symbol>
        <lines>TBD</lines>
        <reason>Zod schema for webhook payload validation - defines attachments array structure</reason>
      </artifact>
    </code>
    <dependencies>
      <typescript>
        <package name="zod" version="latest">Schema validation for webhook payload</package>
        <package name="@types/node" version="latest">TypeScript type definitions</package>
      </typescript>
      <node>
        <builtin>Native types (Buffer, etc.)</builtin>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
- Don't download images yet - only detect and parse metadata (Story 3.2 handles downloads)
- Handle missing attachments field gracefully (return empty array, not error)
- Log attachment count and types but NOT URLs or content (security/privacy)
- Attachments without required fields should be skipped with warning, not crash
- Use TypeScript strict mode with proper type definitions
- Follow kebab-case naming for files (email-processor.ts)
- Export named functions (not default exports for services)
- Co-locate tests with source (email-processor.test.ts)
  </constraints>

  <interfaces>
    <interface>
      <name>Attachment</name>
      <kind>TypeScript interface</kind>
      <signature>
interface Attachment {
  url: string;
  filename: string;
  contentType: string;
}
      </signature>
      <path>src/services/email-processor.ts</path>
    </interface>
    <interface>
      <name>detectAttachments</name>
      <kind>Function signature</kind>
      <signature>
export function detectAttachments(payload: WebhookPayload): Attachment[]
      </signature>
      <path>src/services/email-processor.ts</path>
    </interface>
    <interface>
      <name>WebhookPayload</name>
      <kind>Zod schema / TypeScript type</kind>
      <signature>
z.object({
  from: z.string().email(),
  to: z.string().email(),
  subject: z.string(),
  text: z.string().optional(),
  attachments: z.array(z.object({
    url: z.string().url(),
    filename: z.string(),
    contentType: z.string()
  })).optional()
})
      </signature>
      <path>src/lib/schemas.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Use vitest as testing framework. Tests should be co-located with source files (*.test.ts). Follow BDD-style describe/it blocks. Test files structure: describe('Service Name', () => { describe('function name', () => { it('should handle specific case', () => {}); }); }); Use strict TypeScript types in tests. Mock external dependencies (webhook payloads, etc.).
    </standards>
    <locations>
src/**/*.test.ts (co-located with source files)
    </locations>
    <ideas>
      <test acceptanceCriteriaId="AC1">
        <description>Test detectAttachments with valid payload containing multiple attachments</description>
        <approach>Create mock payload with 2-3 attachments, verify function returns correct Attachment array</approach>
      </test>
      <test acceptanceCriteriaId="AC2">
        <description>Test detectAttachments with missing attachments field</description>
        <approach>Create payload without attachments field, verify function returns empty array</approach>
      </test>
      <test acceptanceCriteriaId="AC3">
        <description>Test detectAttachments with empty attachments array</description>
        <approach>Create payload with attachments: [], verify function returns empty array</approach>
      </test>
      <test acceptanceCriteriaId="AC4">
        <description>Test detectAttachments with attachment missing required fields</description>
        <approach>Create payload with attachment missing url or filename, verify it's skipped with warning logged</approach>
      </test>
      <test acceptanceCriteriaId="AC5">
        <description>Test logging output format for attachment detection</description>
        <approach>Mock logger, verify log includes msg, attachmentCount, and attachment metadata (filename/contentType only)</approach>
      </test>
    </ideas>
  </tests>
</story-context>
