<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.5</storyId>
    <title>Implement Structured Logging Infrastructure</title>
    <status>drafted</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/jima/Code/email_anaylyzer/docs/sprint-artifacts/epic-1-story-1.5.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>structured JSON logging with correlation IDs</iWant>
    <soThat>I can debug issues by tracing individual requests through the system</soThat>
    <tasks>
- Configure pino logger in src/app.ts during Fastify initialization
- Set log level from environment variable (process.env.LOG_LEVEL || 'info')
- Configure pino serializers for request objects (method, url, remoteAddress)
- Ensure correlation ID (request.id) is auto-generated by Fastify for each request
- Configure log format as JSON for structured parsing
- Set log output to stdout (PM2 will capture to files)
- Define log level usage guidelines (info, warn, error, fatal)
- Implement logging helpers in src/lib/logger.ts if needed
- Add structured context to all logs (timestamp, level, correlation ID, message, key-value pairs)
- Ensure sensitive data is NOT logged (API keys, full email content)
- Only log metadata for emails (sender, has_text, has_image, length)
- Test log output format matches expected JSON structure
- Verify correlation ID appears in all request-related logs
- Document logging patterns for future development
</tasks>
  </story>

  <acceptanceCriteria>
**Given** Fastify is configured with pino logger
**When** a request is processed
**Then** each request gets a unique correlation ID (Fastify auto-generated request.id)

**And** all logs include:
- Timestamp (ISO 8601, UTC)
- Log level (info, warn, error, fatal)
- Correlation ID (request.id)
- Message
- Structured context (key-value pairs)

**And** log levels are used appropriately:
- `info`: Normal operations (service start, request received, response sent)
- `warn`: Recoverable issues (timeout, retry)
- `error`: Failures (API errors, validation failures)
- `fatal`: Service crash

**And** logs are written to stdout (PM2 captures to files)

**And** log format is JSON for structured parsing

**And** sensitive data is NOT logged (API keys, email content beyond metadata)

**And** example log structure:
```json
{
  "level": 30,
  "time": 1700000000000,
  "pid": 12345,
  "hostname": "sparky",
  "reqId": "req-abc123",
  "msg": "Request received",
  "sender": "user@company.com",
  "hasScreenshot": true
}
```
</acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Relevant Documentation Artifacts -->
      <artifact>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Logging & Monitoring (FR33-39)</section>
        <snippet>FR33: Log every inbound email with sender and timestamp. FR36: Log all errors with full context. FR37: Track response time metrics. FR38: Provide structured logs for debugging and auditing. FR39: Log content type (screenshot, text, or both).</snippet>
      </artifact>
      <artifact>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Non-Functional Requirements - Security</section>
        <snippet>NFR-S1: Email content not persisted beyond 30-day log retention. NFR-S2: Logs containing email content stored securely with restricted access. NFR-S8: All email processing events logged with sender identity and timestamp. NFR-S9: Logs are tamper-evident (append-only).</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Technology Stack - Logging</section>
        <snippet>pino - Fast, structured JSON logging (Fastify default). Includes automatic correlation IDs built-in (request.id). Async logging doesn't block request handling. PM2 handles log rotation (daily, 30-day retention).</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Logging Strategy</section>
        <snippet>Log Levels: info (normal operations), warn (recoverable issues), error (failures), fatal (service crash). Structured format with correlation ID (request.id), sender, metadata. Never log API keys or full email content - only metadata (sender, has_text, has_image). Pino writes to stdout, PM2 captures to files.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Consistency Rules - Logging Strategy</section>
        <snippet>Correlation IDs (NFR-M4): Fastify auto-generates request.id for each webhook request. Pass through all log calls: request.log.info(). Include in error responses for debugging. Structured log format with timestamp (ISO 8601 UTC), level, correlation ID, message, context.</snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.5 Details</section>
        <snippet>Prerequisites: Story 1.1 (Fastify initialized with pino). Technical: Configure pino in src/app.ts, set log level from env var, configure serializers, never log full email content - only metadata. PM2 handles log rotation (Story 1.4).</snippet>
      </artifact>
    </docs>
    <code>
      <!-- Existing Code and Interfaces -->
      <!-- Note: This story configures pino logger in src/app.ts during Fastify initialization -->
      <artifact>
        <path>src/app.ts</path>
        <kind>application setup</kind>
        <symbol>Fastify initialization</symbol>
        <lines>TBD - needs pino logger configuration</lines>
        <reason>This story adds pino logger configuration to Fastify initialization. Logger config includes level, serializers, and structured logging setup.</reason>
      </artifact>
      <artifact>
        <path>src/lib/logger.ts</path>
        <kind>logging utilities</kind>
        <symbol>logging helpers (optional)</symbol>
        <lines>N/A - may be created if needed</lines>
        <reason>Optional helper utilities for consistent logging patterns across the application. May include functions for redacting sensitive data, formatting log messages, etc.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <pino>Fastify default - Fast, structured JSON logger with correlation IDs</pino>
        <fastify>latest - Includes pino by default, provides request.id for correlation</fastify>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
- MUST use pino logger (Fastify default - already included)
- MUST configure logger in src/app.ts during Fastify initialization
- MUST set log level from environment variable (LOG_LEVEL) with default 'info'
- MUST use JSON format for all logs (structured logging)
- MUST write logs to stdout (PM2 captures to files)
- MUST include correlation ID (request.id) in all request-related logs
- MUST include timestamp in ISO 8601 UTC format
- MUST use appropriate log levels: info, warn, error, fatal
- MUST configure request serializers to log method, url, remoteAddress
- MUST NOT log sensitive data (API keys, passwords, tokens)
- MUST NOT log full email content (only metadata: sender, has_text, has_image, length)
- MUST follow NFR-M4 (correlation IDs for tracing)
- MUST follow FR33-39 (comprehensive logging requirements)
- MUST support structured context (key-value pairs) in log messages
- MUST enable async logging (pino default - doesn't block requests)
</constraints>

  <interfaces>
- Pino Logger Configuration (src/app.ts):
  ```typescript
  import Fastify from 'fastify';

  const app = Fastify({
    logger: {
      level: process.env.LOG_LEVEL || 'info',
      serializers: {
        req: (req) => ({
          method: req.method,
          url: req.url,
          remoteAddress: req.ip
        }),
        res: (res) => ({
          statusCode: res.statusCode
        })
      }
    }
  });
  ```

- Using Logger in Route Handlers:
  ```typescript
  fastify.get('/example', async (request, reply) => {
    // Info log with structured data
    request.log.info({
      sender: email.from,
      hasText: true
    }, 'Processing email');

    // Error log with context
    request.log.error({
      err: error,
      correlationId: request.id
    }, 'Failed to process email');
  });
  ```

- Log Levels (pino):
  - `fatal` (60): Service crash, unrecoverable error
  - `error` (50): API failures, validation errors
  - `warn` (40): Timeouts, retries, recoverable issues
  - `info` (30): Normal operations (default)
  - `debug` (20): Detailed debugging (not used in production)
  - `trace` (10): Very detailed (not used in production)

- Structured Log Output Format:
  ```json
  {
    "level": 30,
    "time": 1700000000000,
    "pid": 12345,
    "hostname": "sparky",
    "reqId": "req-abc123",
    "msg": "Request received",
    "sender": "user@company.com",
    "hasScreenshot": true,
    "hasText": false
  }
  ```

- Correlation ID Access:
  - Automatic: Fastify generates `request.id` for each request
  - Usage: Pass logger to functions: `myFunction(data, request.log)`
  - All logs via `request.log.*` automatically include reqId

- Sensitive Data Guidelines:
  - NEVER log: API keys, passwords, tokens, full email bodies, base64 images
  - OK to log: sender email, subject, metadata (has_text, has_image, length)
  - Always: Sanitize error messages before logging
</interfaces>

  <tests>
    <standards>Test pino logger configuration and structured log output. Verify correlation IDs appear in logs. Test that sensitive data is NOT logged. Verify log levels are used appropriately. Integration tests should capture log output and validate JSON structure. Unit tests can verify logging helper functions if created.</standards>
    <locations>
- src/lib/logger.test.ts (if logging helpers created)
- Integration tests: Verify log output during request processing
- Manual verification: Check log format matches JSON structure
</locations>
    <ideas>
- Test: Pino logger is configured in Fastify with correct log level
- Test: Each request generates unique correlation ID (request.id)
- Test: All logs include timestamp in ISO 8601 UTC format
- Test: All logs include correlation ID (reqId field)
- Test: Logs are in JSON format (structured)
- Test: Logs are written to stdout (captured by PM2)
- Test: Request serializer logs method, url, remoteAddress (not full request body)
- Test: Response serializer logs statusCode (not full response)
- Test: info level logs for normal operations
- Test: warn level logs for recoverable issues
- Test: error level logs for failures
- Test: fatal level logs for service crashes
- Test: Sensitive data (API keys) is NOT logged
- Test: Full email content is NOT logged (only metadata)
- Test: Log metadata includes sender, hasText, hasImage
- Test: Structured context (key-value pairs) appears in logs
- Test: LOG_LEVEL environment variable controls log output
</ideas>
  </tests>
</story-context>
