# Story 5.2: Format Success Email Responses with Feedback

**Epic:** Epic 5: Response Delivery & User Feedback
**Status:** ready-for-dev
**Story Points:** 3
**Prerequisites:** Story 4.3 (LLM feedback extracted)

## User Story

As a **team member**,
I want **to receive AI feedback in a well-formatted email**,
So that **I can easily read and act on the suggestions**.

## Acceptance Criteria

**Given** LLM analysis completed successfully with feedback text
**When** formatting the response email
**Then** subject line follows pattern: `Re: <original_subject>`
- Example: Original = "Draft: Customer Follow-up" → Response = "Re: Draft: Customer Follow-up"

**And** email body is plain text with this structure:
```
Hi,

I've analyzed your email draft and here's my feedback:

[LLM feedback text]

---
This analysis was generated by Email Analyzer
If you have questions, contact your CMO.
```

**And** LLM feedback text is inserted verbatim (no modifications)

**And** email body length is validated:
- If total body exceeds 10,000 characters, log warning (but don't truncate)
- This helps identify unexpected LLM output

**And** formatting handles edge cases:
- Empty original subject → subject = "Re: Your email draft"
- Multi-line feedback → preserved with proper line breaks
- Special characters in feedback → properly encoded for plain text

**And** response formatting is encapsulated in dedicated function

**And** formatted email details logged (without body content):
```json
{
  "msg": "Success email formatted",
  "to": "user@company.com",
  "subject": "Re: Draft email",
  "bodyLength": 456
}
```

## Technical Notes

- Create `src/services/email-formatter.ts`
- Export function: `formatSuccessEmail(to: string, originalSubject: string, feedback: string): EmailContent`
- Type definition:
  ```typescript
  interface EmailContent {
    to: string;
    subject: string;
    body: string;
  }
  ```
- Subject pattern: `Re: ${originalSubject || 'Your email draft'}`
- Body template (use template literals for clean formatting)
- Preserve whitespace and line breaks in feedback
- Footer is static text (no personalization in MVP)
- Load footer text from config for easy customization (optional)
- Don't log actual feedback content - only metadata

## Dev Agent Record

**Context Reference:** docs/sprint-artifacts/epic-5-story-5.2.context.xml
**Implementation Notes:** _[To be filled during development]_

## Testing Requirements

- [ ] Unit tests for all new functions
- [ ] Integration tests for API endpoints (if applicable)
- [ ] Error handling validation
- [ ] Configuration validation (if applicable)

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Code reviewed and approved
- [ ] All tests passing (100%)
- [ ] Documentation updated
- [ ] No new linter errors
- [ ] Changes committed to git
